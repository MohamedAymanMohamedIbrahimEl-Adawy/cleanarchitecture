name: ğŸ iOS CI/CD

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  # ------------------------
  # ğŸ iOS Dev Job
  # ------------------------
  ios-dev:
    name: ğŸ iOS Dev
    runs-on: macos-latest

    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.0"

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ” Setup SSH for Match
        env:
          MATCH_KEY: ${{ secrets.MATCH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$MATCH_KEY" > ~/.ssh/match_rsa
          chmod 600 ~/.ssh/match_rsa
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/match_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: ğŸ› ï¸ Install Fastlane
        run: |
          gem install bundler
          bundle install

      - name: ğŸš€ Run Fastlane for dev
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
        run: bundle exec fastlane dev

  # ------------------------
  # ğŸ iOS Stage Job
  # ------------------------
  ios-stage:
    name: ğŸ iOS Stage
    runs-on: macos-latest

    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.0"

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ” Setup SSH for Match
        env:
          MATCH_KEY: ${{ secrets.MATCH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$MATCH_KEY" > ~/.ssh/match_rsa
          chmod 600 ~/.ssh/match_rsa
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/match_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: ğŸ› ï¸ Install Fastlane
        run: |
          gem install bundler
          bundle install

      - name: ğŸš€ Run Fastlane for stage
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
        run: bundle exec fastlane stage

  # ------------------------
  # ğŸ iOS Prod Job
  # ------------------------
  ios-prod:
    name: ğŸ iOS Prod
    runs-on: macos-latest

    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      - name: ğŸ§° Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.0"

      - name: ğŸ“¦ Install dependencies
        run: flutter pub get

      - name: ğŸ” Setup SSH for Match
        env:
          MATCH_KEY: ${{ secrets.MATCH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$MATCH_KEY" > ~/.ssh/match_rsa
          chmod 600 ~/.ssh/match_rsa
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/match_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: ğŸ› ï¸ Install Fastlane
        run: |
          gem install bundler
          bundle install

      - name: ğŸš€ Run Fastlane for prod
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
        run: bundle exec fastlane prod
