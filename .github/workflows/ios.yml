name: 🍏 iOS CI/CD

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  # ------------------------
  # 🍎 iOS Dev Job
  # ------------------------
  ios-dev:
    name: 🍎 iOS Dev
    runs-on: macos-latest

    steps:
      - name: 🔄 Checkout code
        uses: actions/checkout@v4

      - name: 🧰 Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.0"

      - name: 📦 Install dependencies
        run: flutter pub get

      - name: 🔐 Setup SSH for Match
        env:
          MATCH_KEY: ${{ secrets.MATCH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$MATCH_KEY" > ~/.ssh/match_rsa
          chmod 600 ~/.ssh/match_rsa
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/match_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: 🛠️ Install Fastlane
        run: |
          gem install bundler
          bundle install

      - name: 🚀 Run Fastlane for dev
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
        run: bundle exec fastlane dev

  # ------------------------
  # 🍎 iOS Stage Job
  # ------------------------
  ios-stage:
    name: 🍎 iOS Stage
    runs-on: macos-latest

    steps:
      - name: 🔄 Checkout code
        uses: actions/checkout@v4

      - name: 🧰 Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.0"

      - name: 📦 Install dependencies
        run: flutter pub get

      - name: 🔐 Setup SSH for Match
        env:
          MATCH_KEY: ${{ secrets.MATCH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$MATCH_KEY" > ~/.ssh/match_rsa
          chmod 600 ~/.ssh/match_rsa
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/match_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: 🛠️ Install Fastlane
        run: |
          gem install bundler
          bundle install

      - name: 🚀 Run Fastlane for stage
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
        run: bundle exec fastlane stage

  # ------------------------
  # 🍎 iOS Prod Job
  # ------------------------
  ios-prod:
    name: 🍎 iOS Prod
    runs-on: macos-latest

    steps:
      - name: 🔄 Checkout code
        uses: actions/checkout@v4

      - name: 🧰 Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.22.0"

      - name: 📦 Install dependencies
        run: flutter pub get

      - name: 🔐 Setup SSH for Match
        env:
          MATCH_KEY: ${{ secrets.MATCH_KEY }}
        run: |
          mkdir -p ~/.ssh
          echo "$MATCH_KEY" > ~/.ssh/match_rsa
          chmod 600 ~/.ssh/match_rsa
          eval "$(ssh-agent -s)"
          ssh-add ~/.ssh/match_rsa
          ssh-keyscan github.com >> ~/.ssh/known_hosts

      - name: 🛠️ Install Fastlane
        run: |
          gem install bundler
          bundle install

      - name: 🚀 Run Fastlane for prod
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
        run: bundle exec fastlane prod
