name: 🍎 iOS CI/CD

on:
  workflow_dispatch:
  push:
    branches:
      - master

env:
  FLUTTER_VERSION: "3.32.8"


jobs:
  ios-dev:
    name: 🍎 iOS Dev
    runs-on: macos-latest

    steps:
      - name: 🔄 Checkout code
        uses: actions/checkout@v4

      # ✅ 4. Setup Flutter
      - name: 🧩 Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: 🔐 Setup SSH key for match
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.MATCH_GIT_PRIVATE_KEY }}" | base64 --decode > ~/.ssh/match_fastlane
          chmod 600 ~/.ssh/match_fastlane
          echo "Host github.com\n  IdentityFile ~/.ssh/match_fastlane\n  StrictHostKeyChecking no" >> ~/.ssh/config

      - name: 📥 Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'

      - name: 🚀 Install Fastlane
        run: gem install fastlane

      - name: 🛠️ Run Fastlane for Dev
        run: fastlane ios dev
        working-directory: ios
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: git@github.com:MohamedAymanMohamedIbrahimEl-Adawy/fastlane-certificates.git

  ios-stage:
    name: 🍎 iOS Stage
    runs-on: macos-latest

    steps:
      - name: 🔄 Checkout code
        uses: actions/checkout@v4

      # ✅ 4. Setup Flutter
      - name: 🧩 Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: 🔐 Setup SSH key for match
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.MATCH_GIT_PRIVATE_KEY }}" | base64 --decode > ~/.ssh/match_fastlane
          chmod 600 ~/.ssh/match_fastlane
          echo "Host github.com\n  IdentityFile ~/.ssh/match_fastlane\n  StrictHostKeyChecking no" >> ~/.ssh/config

      - name: 📥 Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'

      - name: 🚀 Install Fastlane
        run: gem install fastlane

      - name: 🛠️ Run Fastlane for Stage
        run: fastlane ios stage
        working-directory: ios
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: git@github.com:MohamedAymanMohamedIbrahimEl-Adawy/fastlane-certificates.git

  ios-prod:
    name: 🍎 iOS Prod
    runs-on: macos-latest

    steps:
      - name: 🔄 Checkout code
        uses: actions/checkout@v4
        
      # ✅ 4. Setup Flutter
      - name: 🧩 Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: 🔐 Setup SSH key for match
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.MATCH_GIT_PRIVATE_KEY }}" | base64 --decode > ~/.ssh/match_fastlane
          chmod 600 ~/.ssh/match_fastlane
          echo "Host github.com\n  IdentityFile ~/.ssh/match_fastlane\n  StrictHostKeyChecking no" >> ~/.ssh/config

      - name: 📥 Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'

      - name: 🚀 Install Fastlane
        run: gem install fastlane

      - name: 🛠️ Run Fastlane for Prod
        run: fastlane ios prod
        working-directory: ios
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: git@github.com:MohamedAymanMohamedIbrahimEl-Adawy/fastlane-certificates.git
