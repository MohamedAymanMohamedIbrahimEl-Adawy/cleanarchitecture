name: ğŸ iOS CI/CD

on:
  workflow_dispatch:
  push:
    branches:
      - master

env:
  FLUTTER_VERSION: "3.32.8"


jobs:
  ios-dev:
    name: ğŸ iOS Dev
    runs-on: macos-latest

    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      # âœ… 4. Setup Flutter
      - name: ğŸ§© Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: ğŸ” Setup SSH key for match
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.MATCH_GIT_PRIVATE_KEY }}" | base64 --decode > ~/.ssh/match_fastlane
          chmod 600 ~/.ssh/match_fastlane
          echo "Host github.com\n  IdentityFile ~/.ssh/match_fastlane\n  StrictHostKeyChecking no" >> ~/.ssh/config

      - name: ğŸ“¥ Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'

      - name: ğŸš€ Install Fastlane
        run: gem install fastlane

      - name: ğŸ› ï¸ Run Fastlane for Dev
        run: fastlane ios dev
        working-directory: ios
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: git@github.com:MohamedAymanMohamedIbrahimEl-Adawy/fastlane-certificates.git

  ios-stage:
    name: ğŸ iOS Stage
    runs-on: macos-latest

    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4

      # âœ… 4. Setup Flutter
      - name: ğŸ§© Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: ğŸ” Setup SSH key for match
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.MATCH_GIT_PRIVATE_KEY }}" | base64 --decode > ~/.ssh/match_fastlane
          chmod 600 ~/.ssh/match_fastlane
          echo "Host github.com\n  IdentityFile ~/.ssh/match_fastlane\n  StrictHostKeyChecking no" >> ~/.ssh/config

      - name: ğŸ“¥ Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'

      - name: ğŸš€ Install Fastlane
        run: gem install fastlane

      - name: ğŸ› ï¸ Run Fastlane for Stage
        run: fastlane ios stage
        working-directory: ios
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: git@github.com:MohamedAymanMohamedIbrahimEl-Adawy/fastlane-certificates.git

  ios-prod:
    name: ğŸ iOS Prod
    runs-on: macos-latest

    steps:
      - name: ğŸ”„ Checkout code
        uses: actions/checkout@v4
        
      # âœ… 4. Setup Flutter
      - name: ğŸ§© Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}

      - name: ğŸ” Setup SSH key for match
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.MATCH_GIT_PRIVATE_KEY }}" | base64 --decode > ~/.ssh/match_fastlane
          chmod 600 ~/.ssh/match_fastlane
          echo "Host github.com\n  IdentityFile ~/.ssh/match_fastlane\n  StrictHostKeyChecking no" >> ~/.ssh/config

      - name: ğŸ“¥ Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.1'

      - name: ğŸš€ Install Fastlane
        run: gem install fastlane

      - name: ğŸ› ï¸ Run Fastlane for Prod
        run: fastlane ios prod
        working-directory: ios
        env:
          MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
          MATCH_GIT_URL: git@github.com:MohamedAymanMohamedIbrahimEl-Adawy/fastlane-certificates.git
